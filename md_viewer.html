<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- [保持原有 head 部分不变] -->
  <style>
    /* [原有样式保持不变] */
    /* 新增移动端错误提示样式 */
    #error {
      padding: 15px;
      background: #ffeeee;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }
    
    @media (max-width: 600px) {
      #error {
        margin: 10px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- [保持原有 HTML 结构不变] -->
  <script>
    // 增强的 fetch 函数
    async function safeFetch(url) {
      try {
        // 处理 GitHub 原始内容 URL
        if (url.includes('github.com')) {
          url = url.replace('github.com', 'raw.githubusercontent.com')
                   .replace('/blob/', '/');
        }
        
        const response = await fetch(url, {
          headers: {
            'Accept': 'text/plain',
            'Cache-Control': 'no-cache'
          },
          mode: 'cors'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.text();
      } catch (err) {
        console.error('Fetch error:', err);
        throw new Error('加载内容失败，请检查网络连接或URL有效性');
      }
    }

    // 增强的 YAML 解析
    function parseYAMLFrontmatter(md) {
      try {
        const match = md.match(/^---\s*\n([\s\S]+?)\n---/);
        if (!match) return {};
        
        const yaml = match[1];
        return yaml.split('\n').reduce((result, line) => {
          const idx = line.indexOf(':');
          if (idx > 0) {
            const key = line.slice(0, idx).trim();
            let value = line.slice(idx + 1).trim();
            
            // 处理带引号的值
            if (/^['"].*['"]$/.test(value)) {
              value = value.slice(1, -1);
            }
            
            // 处理数组
            if (value.startsWith('[') && value.endsWith(']')) {
              value = value.slice(1, -1).split(',').map(v => v.trim().replace(/['"]/g, ''));
            } else if ((key === 'tags' || key === 'categories') && value.includes(',')) {
              value = value.split(',').map(v => v.trim());
            }
            
            result[key] = value;
          }
          return result;
        }, {});
      } catch (err) {
        console.error('YAML parse error:', err);
        return {};
      }
    }

    // 修改后的加载逻辑
    async function loadContent() {
      const mdUrl = getQueryVariable('url');
      if (!mdUrl) {
        document.getElementById('error').textContent = '缺少文章URL参数';
        return;
      }

      try {
        const md = await safeFetch(mdUrl);
        const fm = parseYAMLFrontmatter(md);
        
        // 设置标题
        const title = fm.title || decodeURIComponent(mdUrl.split('/').pop().replace(/\.md$/, '').replace(/-/g, ' '));
        document.getElementById('title').textContent = title;
        document.title = `${title} | 森林鸟 · bird.work`;
        
        // 设置元信息
        let metaHtml = '';
        if (fm.date) metaHtml += `<strong>日期</strong> ${fm.date}`;
        if (fm.author) metaHtml += `<strong>作者</strong> ${fm.author}`;
        
        if (fm.categories && fm.categories.length) {
          const cats = Array.isArray(fm.categories) ? fm.categories : [fm.categories];
          metaHtml += `<strong>分类</strong> <span class="categories">${
            cats.map(cat => `<span class="category">${cat}</span>`).join('')
          }</span>`;
        }
        
        if (fm.tags && fm.tags.length) {
          const tags = Array.isArray(fm.tags) ? fm.tags : [fm.tags];
          metaHtml += `<strong>标签</strong> <span class="tags">${
            tags.map(tag => `<span class="tag">${tag}</span>`).join('')
          }</span>`;
        }
        
        document.getElementById('meta').innerHTML = metaHtml;
        
        // 渲染内容
        const body = md.replace(/^---\s*\n[\s\S]+?\n---/, '').trim();
        document.getElementById('content').innerHTML = marked.parse(body || '*（暂无内容）*');
        document.getElementById('end-divider').style.display = '';
        
      } catch (err) {
        console.error('Load content failed:', err);
        document.getElementById('error').innerHTML = `
          <p>${err.message}</p>
          <p>尝试方案：</p>
          <ol>
            <li>检查网络连接</li>
            <li>确认URL是否有效</li>
            <li>稍后重试</li>
          </ol>
        `;
      }
    }

    // 初始化加载
    document.addEventListener('DOMContentLoaded', loadContent);
  </script>
</body>
</html>
