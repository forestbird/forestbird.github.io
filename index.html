<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Markdown 日志索引</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>Markdown 日志索引</h1>
  <div id="md-list"></div>
  <hr>
  <div id="md-content"></div>
  <div id="error" style="color: red;"></div>
  <script>
    const repo = 'forestbird/forestbird.github.io';
    const branch = 'main'; // 如为 master，请改为 master
    const dir = '_posts';
    const api = `https://api.github.com/repos/${repo}/contents/${dir}?ref=${branch}`;

    function loadMd(url) {
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error('无法加载日志内容: ' + res.statusText);
          return res.text();
        })
        .then(md => {
          document.getElementById('md-content').innerHTML = marked.parse(md);
        })
        .catch(err => {
          document.getElementById('md-content').textContent = err.message;
        });
    }

    fetch(api)
      .then(res => {
        if (!res.ok) throw new Error(`API 请求失败: ${res.status} ${res.statusText}`);
        return res.json();
      })
      .then(files => {
        if (!Array.isArray(files)) throw new Error('API 响应不是文件数组，可能目录不存在或拼写错误。');
        const mdFiles = files
          .filter(f => f.name.endsWith('.md'))
          .sort((a, b) => a.name.localeCompare(b.name));
        const list = document.getElementById('md-list');
        if (mdFiles.length === 0) {
          list.textContent = '没有找到任何 .md 日志文件。';
          return;
        }
        mdFiles.forEach((file, idx) => {
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = file.name;
          a.addEventListener('click', (e) => {
            e.preventDefault();
            loadMd(file.download_url);
            // 高亮当前选中
            [...list.children].forEach(el => el.style.fontWeight = 'normal');
            a.style.fontWeight = 'bold';
          });
          list.appendChild(a);
          list.appendChild(document.createElement('br'));
          // 默认加载最新
          if (idx === mdFiles.length - 1) {
            loadMd(file.download_url);
            a.style.fontWeight = 'bold';
          }
        });
      })
      .catch(err => {
        document.getElementById('error').textContent = '无法获取日志列表: ' + err.message;
      });
  </script>
</body>
</html>
